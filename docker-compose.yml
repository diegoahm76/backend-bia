version: '3.8'

services: # the different images that will be running as containers

  db: # service name
    # image name of the postgres database. during build, this will be pulled from dockerhub and a container spun up from it.
    image: postgres:14-alpine 
    volumes:
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data:/var/lib/postgresql/data/
    # access credentials from the .env file
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=1234
      - POSTGRES_DB=bia
    ports:
      - 5435:5432
    networks:
      - db_network
    restart: "on-failure"

  db_estaciones: # service name
    # image name of the postgres database. during build, this will be pulled from dockerhub and a container spun up from it.
    image: postgres:14-alpine 
    volumes:
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data_estaciones:/var/lib/postgresql/data/
    # access credentials from the .env file
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=1234
      - POSTGRES_DB=bia_estaciones
    ports:
      - 5436:5432
    networks:
      - db_network
    restart: "on-failure"

  web: # service name
    #build the image for the web service from the dockerfile in parent directory.  
    build: . 
    # command directive passes the parameters to the service and they will be executed by the service. In this example, these are django commands which will be executed in the container where django lives.
    command: sh -c "python manage.py runserver 0.0.0.0:8000" 
    # map data and files from parent directory in host to microservice directory in docker container
    volumes: 
      - .:/backend-bia 
      - static_volume:/home/app/backend-bia/build/static
    # file where env variables are stored. Used as best practice so as not to expose secret keys
    env_file: 
      - .env # name of the env file
    # name of the image
    image: backend-bia-app 
    # expose the port to other services defined here so that they can access this service via the exposed port. In the case of Django, this is 8000 by default
    ports: 
      - 8000:8000 # retrieved from the .env file
    restart: "on-failure"
    # cannot start if db service is not up and running
    depends_on: 
      - db
      - db_estaciones
    links:
      - db:db
      - db_estaciones:db_estaciones
    networks:
      - db_network

volumes:
  postgres_data:
  postgres_data_estaciones:
  static_volume:

networks:
  db_network:
    driver: bridge
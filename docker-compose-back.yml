version: '3.8'

services: # the different images that will be running as containers
  web: # service name
    #build the image for the web service from the dockerfile in parent directory.  
    build: . 
    # command directive passes the parameters to the service and they will be executed by the service. In this example, these are django commands which will be executed in the container where django lives.
    command: sh -c "python manage.py makemigrations almacen conservacion gestion_documental seguridad transversal recaudo &&
                    python manage.py makemigrations &&
                    python manage.py migrate &&
                    python manage.py makemigrations estaciones &&
                    python manage.py migrate estaciones --database=bia-estaciones &&
                    python manage.py loaddata paises_fixtures.json departamentos_fixtures.json municipios_fixtures.json estadocivil_fixtures.json clases_tercero_fixtures.json operaciones_sobre_usuario_fixtures.json tipodocumento_fixtures.json estructura_menus_fixtures.json modulos_fixtures.json permisos_fixtures.json roles_fixtures.json permisos_modulo_fixtures.json permisos_modulo_rol_fixtures.json sexo_fixtures.json persona_fixtures.json usuario_fixtures.json usuarios_rol_fixtures.json estados_articulo_fixtures.json magnitudes_fixtures.json porcentajes_iva_fixtures.json unidades_medidas_fixtures.json tipos_medios_doc_fixture.json formatos_tipos_medio.json tipos_activo_fixtures.json tipos_depreciacion_activos_fixtures.json metodos_valoracion_articulos_fixtures.json tipos_entrada_fixtures.json permisos_gd_fixtures.json cod_disposicion_final_fixtures.json &&
                    python manage.py runserver 0.0.0.0:8000" 
    # map data and files from parent directory in host to microservice directory in docker container
    volumes: 
      - .:/backend-bia 
      - static_volume:/home/app/backend-bia/build/static
    # file where env variables are stored. Used as best practice so as not to expose secret keys
    env_file: 
      - .env # name of the env file
    # name of the image
    image: backend-bia-app 
    # expose the port to other services defined here so that they can access this service via the exposed port. In the case of Django, this is 8000 by default
    ports: 
      - 8000:8000 # retrieved from the .env file
    restart: "on-failure"
    # cannot start if db service is not up and running

volumes:
  static_volume: